"use strict";(()=>{var S=Object.defineProperty;var g=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var y=(n,t,e)=>t in n?S(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,p=(n,t)=>{for(var e in t||={})v.call(t,e)&&y(n,e,t[e]);if(g)for(var e of g(t))C.call(t,e)&&y(n,e,t[e]);return n};var f=new Map,T=15*60*1e3,E=60,u=30,h=40,l={largeText:!0,highContrast:!1,verboseWarnings:!0,animationReduced:!1},d={enabled:!0,autoHide:!1,autoHideDelay:1e4,showOnAllPages:!1,alwaysShowScore:!0};function x(){let n=document.querySelectorAll("a[href]"),t=new Set;return n.forEach(e=>{try{let s=e.getAttribute("href");if(!s)return;if(s.startsWith("http://")||s.startsWith("https://")){let o=new URL(s);t.add(o.hostname)}}catch(s){}}),Array.from(t)}function k(n){return l.verboseWarnings?n<u?"\u26A0\uFE0F WARNING: This website appears to be unsafe! High risk of scam or fraud. Avoid clicking.":"\u26A0\uFE0F CAUTION: This website has a low trust score and might be unsafe. Click with caution.":"\u26A0\uFE0F Potential scam: low trust score"}function L(n){let t=100-n,e=document.createElement("div");e.className="sp-risk-meter";let s=document.createElement("div");s.className="sp-risk-meter-fill",s.style.setProperty("--risk-level",`${t}%`);let o=document.createElement("div");o.className="sp-risk-meter-marker",o.style.left="40%";let r=document.createElement("div");return r.className="sp-risk-meter-value",r.textContent=`Score: ${n}/100`,r.style.left=`${100-t}%`,e.appendChild(s),e.appendChild(o),e.appendChild(r),e}function b(n,t){if(!d.enabled)return;if(!d.showOnAllPages){let c=window.location.pathname;if(c!=="/"&&c!=="")return}let e=document.querySelector(".sp-safety-banner");if(e&&e.remove(),t>=h)return;let s=document.createElement("div");s.className="sp-safety-banner",t<u?s.classList.add("high-risk"):s.classList.add("medium-risk");let o=t<u?"HIGH RISK":"CAUTION",r=t<u?`This website (${n}) has been flagged as potentially unsafe with a very low security score.`:`This website (${n}) has a low security score and might be risky to use.`;s.innerHTML=`
    <div class="sp-safety-banner-content">
      <span class="sp-safety-banner-warning-icon">\u26A0\uFE0F</span>
      <span class="sp-safety-banner-text">
        <strong>${o}:</strong> ${r}
      </span>
      ${d.alwaysShowScore?`<div class="sp-safety-banner-score">
          Score: <span class="sp-safety-banner-score-value">${t}</span>
        </div>`:""}
      <button class="sp-safety-banner-action" id="sp-check-site">Check Details</button>
    </div>
    <button class="sp-safety-banner-close" id="sp-close-banner">\xD7</button>
  `,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},500);let a=document.getElementById("sp-close-banner");a&&a.addEventListener("click",()=>{s.classList.remove("show"),setTimeout(()=>{s.remove()},300);try{let c=JSON.parse(localStorage.getItem("sp-dismissed-banners")||"{}");c[n]=Date.now(),localStorage.setItem("sp-dismissed-banners",JSON.stringify(c))}catch(c){console.error("Failed to store banner dismissal:",c)}});let i=document.getElementById("sp-check-site");i&&i.addEventListener("click",()=>{window.open(`https://scam-protector.com?domain=${encodeURIComponent(n)}`,"_blank")}),d.autoHide&&setTimeout(()=>{s.parentElement&&(s.classList.remove("show"),setTimeout(()=>{s.remove()},300))},d.autoHideDelay)}async function P(){let n=window.location.hostname;if(n){try{let e=JSON.parse(localStorage.getItem("sp-dismissed-banners")||"{}")[n];if(e&&Date.now()-e<60*60*1e3){console.debug(`[Scam-Protector] Banner for ${n} was recently dismissed, not showing again.`);return}}catch(t){}try{let e=(await w([n]))[n];e!==void 0&&e<h&&(console.debug(`[Scam-Protector] Creating safety banner for ${n} with score ${e}`),b(n,e))}catch(t){console.error("[Scam-Protector] Error checking current page safety:",t)}}}async function H(){try{f.clear(),await chrome.runtime.sendMessage({action:"getScores",clearCache:!0}),console.log("[Scam-Protector] Cache cleared successfully"),await m()}catch(n){console.error("[Scam-Protector] Failed to clear cache:",n)}}function N(){if(!(window.location.search.includes("sp-debug")||window.location.hostname==="localhost"||window.location.hostname.includes("test")))return;let t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.right="10px",t.style.padding="10px",t.style.background="rgba(0,0,0,0.8)",t.style.color="white",t.style.borderRadius="5px",t.style.zIndex="9999999",t.style.fontSize="12px",t.style.fontFamily="Arial, sans-serif";let e=document.createElement("button");e.textContent="Clear Score Cache",e.style.background="#ff3333",e.style.border="none",e.style.color="white",e.style.padding="5px 10px",e.style.borderRadius="3px",e.style.cursor="pointer",e.addEventListener("click",H);let s=document.createElement("button");s.textContent="Force Re-scan",s.style.background="#3333ff",s.style.border="none",s.style.color="white",s.style.padding="5px 10px",s.style.marginLeft="5px",s.style.borderRadius="3px",s.style.cursor="pointer",s.addEventListener("click",()=>m());let o=document.createElement("div");o.textContent="Scam-Protector debug mode",o.style.marginTop="5px",o.style.fontSize="10px",t.appendChild(e),t.appendChild(s),t.appendChild(o),document.body.appendChild(t)}function A(n){document.querySelectorAll("a[href]").forEach(e=>{try{let s=e.getAttribute("href");if(!s)return;if(s.startsWith("http://")||s.startsWith("https://")){let o=new URL(s),r=n[o.hostname];if(r!==void 0&&(console.debug(`Scam-Protector: ${o.hostname} has score ${r}`),r<E)){e.classList.add("sp-danger");let a=k(r);e.setAttribute("data-sp-warning",a),e.setAttribute("data-sp-score",r.toString()),e.setAttribute("aria-description",a);let i=L(r);e.appendChild(i),r<u&&e.classList.add("sp-danger-badge"),l.largeText&&e.style.setProperty("--sp-warning-font-size","16px"),l.highContrast&&e.classList.add("sp-high-contrast"),l.animationReduced&&e.style.setProperty("--sp-animation","none")}}}catch(s){}})}async function w(n){let t=Date.now(),e={},s=[];if(n.forEach(o=>{let r=f.get(o);r&&t-r.timestamp<T?e[o]=r.score:s.push(o)}),s.length===0)return e;try{let o=await chrome.runtime.sendMessage({action:"getScores",hosts:s});return Object.entries(o).forEach(([r,a])=>{f.set(r,{score:a,timestamp:t})}),p(p({},e),o)}catch(o){return console.warn("Scam-Protector: Failed to get scores",o),e}}async function m(){let n=x();if(n.length===0)return;let t=await w(n);A(t);let e=window.location.hostname;if(e&&t[e]!==void 0){let s=t[e];s<h&&(console.debug(`[Scam-Protector] Current page (${e}) has low score: ${s}`),b(e,s))}}function R(n,t){let e=!1;return function(...s){e||(n.apply(this,s),e=!0,setTimeout(()=>{e=!1},t))}}function I(){let n=R(m,1e3);new MutationObserver(e=>{let s=!1;for(let o of e){if(o.type==="childList"||o.type==="attributes"){if(o.type==="attributes"&&o.attributeName==="href"){s=!0;break}if(o.addedNodes.length>0)for(let r=0;r<o.addedNodes.length;r++){let a=o.addedNodes[r];if(a.nodeType===Node.ELEMENT_NODE){let i=a;if(i.tagName==="A"||i.querySelector("a")){s=!0;break}}}}if(s)break}s&&("requestIdleCallback"in window?window.requestIdleCallback(()=>n()):setTimeout(()=>n(),100))}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["href"]})}async function M(){try{let n=await chrome.storage.sync.get("accessibility");if(n.accessibility&&Object.assign(l,n.accessibility),l.largeText){let t=document.createElement("style");t.textContent=`
        .sp-danger::before {
          font-size: 18px !important;
          padding: 10px 14px !important;
        }
      `,document.head.appendChild(t)}}catch(n){console.warn("Scam-Protector: Could not load accessibility settings")}}document.addEventListener("DOMContentLoaded",()=>{M().then(()=>{m(),I(),setTimeout(P,1e3),setTimeout(N,1e3)})});window.addEventListener("load",()=>{setTimeout(m,1e3)});})();
